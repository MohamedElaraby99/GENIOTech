{% extends "base.html" %}

{% block title %}Customers - GENIOTECH{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-user-friends"></i> Customer Management</h2>
                    <p class="text-muted">
                        {% if current_user.role == 'instructor' %}
                        Manage your assigned students and track their progress
                        {% else %}
                        Manage all customers in the system
                        {% endif %}
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('add_customer') }}" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add Customer
                    </a>
                    <a href="{{ url_for('import_customers') }}" class="btn btn-info">
                        <i class="fas fa-file-excel"></i> Import Excel
                    </a>
                    <button type="button" class="btn btn-success" data-bs-toggle="modal"
                        data-bs-target="#campaignModal">
                        <i class="fas fa-bullhorn"></i> WhatsApp Campaign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>{{ customers|length }}</h5>
                            <small>Total Customers</small>
                        </div>
                        <i class="fas fa-users fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>{{ customers|selectattr('status', 'eq', 'active')|list|length }}</h5>
                            <small>Active</small>
                        </div>
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>{{ customers|selectattr('status', 'eq', 'needs_follow_up')|list|length }}</h5>
                            <small>Need Follow-up</small>
                        </div>
                        <i class="fas fa-exclamation-triangle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5>{{ customers|selectattr('status', 'eq', 'no_show')|list|length }}</h5>
                            <small>No-Shows</small>
                        </div>
                        <i class="fas fa-times-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-filter"></i> Filters</h6>
                    <form method="GET" class="row g-3">
                        <!-- Age Filters -->
                        <div class="col-md-2">
                            <label for="age_filter" class="form-label">Age Group</label>
                            <select class="form-select" id="age_filter" name="age_filter">
                                <option value="">All Ages</option>
                                <option value="under_18" {{ 'selected' if age_filter=='under_18' else '' }}>Under 18
                                </option>
                                <option value="18_25" {{ 'selected' if age_filter=='18_25' else '' }}>18-25 years
                                </option>
                                <option value="26_35" {{ 'selected' if age_filter=='26_35' else '' }}>26-35 years
                                </option>
                                <option value="36_50" {{ 'selected' if age_filter=='36_50' else '' }}>36-50 years
                                </option>
                                <option value="over_50" {{ 'selected' if age_filter=='over_50' else '' }}>Over 50
                                </option>
                                <option value="unknown" {{ 'selected' if age_filter=='unknown' else '' }}>Age Unknown
                                </option>
                            </select>
                        </div>
                        <div class="col-md-1">
                            <label for="min_age" class="form-label">Min Age</label>
                            <input type="number" class="form-control" id="min_age" name="min_age"
                                value="{{ min_age or '' }}" min="1" max="120" placeholder="Min">
                        </div>
                        <div class="col-md-1">
                            <label for="max_age" class="form-label">Max Age</label>
                            <input type="number" class="form-control" id="max_age" name="max_age"
                                value="{{ max_age or '' }}" min="1" max="120" placeholder="Max">
                        </div>

                        <!-- Added By Filter -->
                        <div class="col-md-2">
                            <label for="created_by_filter" class="form-label">Added By</label>
                            <select class="form-select" id="created_by_filter" name="created_by_filter">
                                <option value="">All Staff</option>
                                {% for staff in customer_service_staff %}
                                <option value="{{ staff.id }}" {{ 'selected' if created_by_filter==staff.id|string
                                    else '' }}>
                                    {{ staff.first_name }} {{ staff.last_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Enrollment Status Filter -->
                        <div class="col-md-2">
                            <label for="enrollment_status_filter" class="form-label">Course Status</label>
                            <select class="form-select" id="enrollment_status_filter" name="enrollment_status_filter">
                                <option value="">All Statuses</option>
                                <option value="enrolled" {{ 'selected' if enrollment_status_filter=='enrolled' else ''
                                    }}>
                                    Enrolled in Groups
                                </option>
                                <option value="not_enrolled" {{ 'selected' if enrollment_status_filter=='not_enrolled'
                                    else '' }}>
                                    Not in Groups
                                </option>
                                <option value="has_courses" {{ 'selected' if enrollment_status_filter=='has_courses'
                                    else '' }}>
                                    Has Individual Courses
                                </option>
                                <option value="no_courses" {{ 'selected' if enrollment_status_filter=='no_courses'
                                    else '' }}>
                                    No Courses
                                </option>
                            </select>
                        </div>

                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter"></i> Apply
                            </button>
                            <a href="{{ url_for('customers') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-list"></i> Customer List
                            <small class="text-muted">(<span id="totalCustomerCount">{{ customers|length }}</span>
                                customers)</small>
                        </h5>
                        <div class="d-flex gap-3 align-items-center">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="selectAllBtn">
                                    <i class="fas fa-check-square"></i> Select All
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="selectNoneBtn">
                                    <i class="fas fa-square"></i> Select None
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="selectVisibleBtn">
                                    <i class="fas fa-eye"></i> Select Visible
                                </button>
                            </div>
                            <div class="badge bg-primary" id="selectionInfo">
                                <span id="selectedCountInfo">0</span> selected
                            </div>
                            <div class="input-group" style="width: 300px;">
                                <input type="text" class="form-control" id="searchInput"
                                    placeholder="Search customers...">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="customersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>
                                        <input type="checkbox" id="selectAll" class="form-check-input">
                                    </th>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Phone 2</th>
                                    <th>Age</th>
                                    <th>Status</th>
                                    <th>Added By</th>
                                    <th>Course Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in customers %}
                                <tr>
                                    <td>
                                        <input type="checkbox" name="customer_select" value="{{ customer.id }}"
                                            class="form-check-input customer-checkbox">
                                    </td>
                                    <td>{{ customer.id }}</td>
                                    <td>{{ customer.first_name }} {{ customer.last_name }}</td>
                                    <td>
                                        {% if customer.phone %}
                                        <div class="d-flex align-items-center gap-2">
                                            <span>{{ customer.phone }}</span>
                                            <div class="btn-group btn-group-sm">
                                                <a href="tel:{{ customer.phone }}" class="btn btn-outline-info btn-sm"
                                                    title="Call {{ customer.first_name }}">
                                                    <i class="fas fa-phone"></i>
                                                </a>
                                                <a href="https://wa.me/{{ customer.phone.replace(' ', '').replace('-', '').replace('(', '').replace(')', '') }}"
                                                    target="_blank" class="btn btn-outline-success btn-sm"
                                                    title="WhatsApp {{ customer.first_name }}">
                                                    <i class="fab fa-whatsapp"></i>
                                                </a>
                                            </div>
                                        </div>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if customer.phone2 %}
                                        <div class="d-flex align-items-center gap-2">
                                            <span>{{ customer.phone2 }}</span>
                                            <div class="btn-group btn-group-sm">
                                                <a href="tel:{{ customer.phone2 }}" class="btn btn-outline-info btn-sm"
                                                    title="Call {{ customer.first_name }}">
                                                    <i class="fas fa-phone"></i>
                                                </a>
                                                <a href="https://wa.me/{{ customer.phone2.replace(' ', '').replace('-', '').replace('(', '').replace(')', '') }}"
                                                    target="_blank" class="btn btn-outline-success btn-sm"
                                                    title="WhatsApp {{ customer.first_name }}">
                                                    <i class="fab fa-whatsapp"></i>
                                                </a>
                                            </div>
                                        </div>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if customer.age %}
                                        <span class="badge bg-light text-dark">{{ customer.age }} years</span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span
                                            class="badge bg-{{ 'success' if customer.status == 'active' else 'warning' if customer.status == 'needs_follow_up' else 'danger' if customer.status == 'no_show' else 'secondary' }}">
                                            {{ customer.status.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if customer.created_by %}
                                        <span class="text-muted small">
                                            <i class="fas fa-user"></i> {{ customer.created_by.first_name }} {{
                                            customer.created_by.last_name }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set active_groups = customer.group_memberships|selectattr('status',
                                        'equalto', 'active')|list %}
                                        {% set has_courses = customer.courses|list %}
                                        {% if active_groups %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-users"></i> In {{ active_groups|length }} Group{{ 's' if
                                            active_groups|length > 1 else '' }}
                                        </span>
                                        {% elif has_courses %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-book"></i> {{ has_courses|length }} Course{{ 's' if
                                            has_courses|length > 1 else '' }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-minus"></i> No Courses
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>{{ customer.created_at.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('customer_detail', customer_id=customer.id) }}"
                                                class="btn btn-outline-primary btn-sm" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('edit_customer', customer_id=customer.id) }}"
                                                class="btn btn-outline-info btn-sm" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-success btn-sm"
                                                title="Add Note" data-bs-toggle="modal"
                                                data-bs-target="#addNoteModal{{ customer.id }}">
                                                <i class="fas fa-sticky-note"></i>
                                            </button>
                                            {% if current_user.role in ['admin', 'customer_service'] %}
                                            <button type="button" class="btn btn-outline-danger btn-sm"
                                                title="Delete Customer" data-bs-toggle="modal"
                                                data-bs-target="#deleteCustomerModal{{ customer.id }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modals -->
{% for customer in customers %}
<div class="modal fade" id="addNoteModal{{ customer.id }}" tabindex="-1"
    aria-labelledby="addNoteModalLabel{{ customer.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNoteModalLabel{{ customer.id }}">
                    <i class="fas fa-sticky-note"></i> Add Note for {{ customer.first_name }} {{ customer.last_name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('add_customer_note', customer_id=customer.id) }}" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="note_content{{ customer.id }}" class="form-label">Note Content <span
                                class="text-danger">*</span></label>
                        <textarea class="form-control" id="note_content{{ customer.id }}" name="note_content" rows="4"
                            required placeholder="Enter your note here..."></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_internal{{ customer.id }}"
                            name="is_internal">
                        <label class="form-check-label" for="is_internal{{ customer.id }}">
                            Internal Note (not visible to customer)
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Add Note
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Customer Modals -->
{% for customer in customers %}
{% if current_user.role in ['admin', 'customer_service'] %}
<div class="modal fade" id="deleteCustomerModal{{ customer.id }}" tabindex="-1"
    aria-labelledby="deleteCustomerModalLabel{{ customer.id }}" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteCustomerModalLabel{{ customer.id }}">
                    <i class="fas fa-exclamation-triangle"></i> Confirm Customer Deletion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="fas fa-warning"></i>
                    <strong>Warning:</strong> This action cannot be undone!
                </div>

                <p>Are you sure you want to delete the following customer?</p>

                <div class="card bg-light">
                    <div class="card-body">
                        <h6 class="card-title"><strong>{{ customer.first_name }} {{ customer.last_name }}</strong></h6>
                        <p class="card-text mb-1">
                            <i class="fas fa-phone"></i> Phone: {{ customer.phone or 'N/A' }}
                        </p>
                        {% if customer.phone2 %}
                        <p class="card-text mb-1">
                            <i class="fas fa-phone"></i> Phone 2: {{ customer.phone2 }}
                        </p>
                        {% endif %}
                        <p class="card-text mb-1">
                            <i class="fas fa-calendar"></i> Age: {{ customer.age or 'N/A' }}
                        </p>
                        <p class="card-text mb-1">
                            <i class="fas fa-info-circle"></i> Status:
                            <span
                                class="badge bg-{{ 'success' if customer.status == 'active' else 'warning' if customer.status == 'needs_follow_up' else 'danger' if customer.status == 'no_show' else 'secondary' }}">
                                {{ customer.status.replace('_', ' ').title() }}
                            </span>
                        </p>
                        <p class="card-text mb-0">
                            <i class="fas fa-user-plus"></i> Added: {{ customer.created_at.strftime('%Y-%m-%d') }}
                            {% if customer.created_by %} by {{ customer.created_by.first_name }} {{
                            customer.created_by.last_name }}{% endif %}
                        </p>
                    </div>
                </div>

                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        <strong>Note:</strong> The customer can only be deleted if they have no related records
                        (tickets, sessions, courses, group memberships, notes, etc.). If deletion fails,
                        you will need to remove or transfer these records first.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <form method="POST" action="{{ url_for('delete_customer', customer_id=customer.id) }}"
                    style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Yes, Delete Customer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<!-- WhatsApp Campaign Modal -->
<div class="modal fade" id="campaignModal" tabindex="-1" aria-labelledby="campaignModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="campaignModalLabel">
                    <i class="fab fa-whatsapp"></i> WhatsApp Campaign
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('send_whatsapp_campaign') }}" method="POST" id="campaignForm">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Selected Customers:</strong> <span id="selectedCount">0</span> customers selected
                    </div>

                    <div class="mb-3">
                        <label for="message_template" class="form-label">Message Template <span
                                class="text-danger">*</span></label>
                        <textarea class="form-control" id="message_template" name="message_template" rows="6"
                            placeholder="Enter your message here..." required></textarea>
                        <div class="form-text">
                            <strong>Available Variables:</strong>
                            <ul class="mb-0">
                                <li><code>{name}</code> - Full name (First Last)</li>
                                <li><code>{first_name}</code> - First name only</li>
                                <li><code>{last_name}</code> - Last name only</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Quick Templates:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="useTemplate('greeting')">
                                Greeting
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="useTemplate('reminder')">
                                Reminder
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="useTemplate('promotion')">
                                Promotion
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="useTemplate('followup')">
                                Follow-up
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Preview:</label>
                        <div class="border p-3 bg-light rounded" id="messagePreview">
                            <em class="text-muted">Enter a message to see preview...</em>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="sendCampaignBtn" disabled>
                        <i class="fab fa-whatsapp"></i> Prepare Campaign
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Simple search functionality
    document.getElementById('searchInput').addEventListener('keyup', function () {
        const searchValue = this.value.toLowerCase();
        const table = document.getElementById('customersTable');
        const rows = table.getElementsByTagName('tr');

        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchValue) ? '' : 'none';
        }

        // Update selection info after filtering
        updateSelectedCount();
    });

    // Select All functionality (header checkbox)
    document.getElementById('selectAll').addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('.customer-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
            const row = checkbox.closest('tr');
            if (this.checked) {
                row.classList.add('table-primary');
                row.style.backgroundColor = '#cfe2ff';
            } else {
                row.classList.remove('table-primary');
                row.style.backgroundColor = '';
            }
        });
        updateSelectedCount();
    });

    // New Select All button
    document.getElementById('selectAllBtn').addEventListener('click', function () {
        const checkboxes = document.querySelectorAll('.customer-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = true;
            const row = checkbox.closest('tr');
            row.classList.add('table-primary');
            row.style.backgroundColor = '#cfe2ff';
        });
        document.getElementById('selectAll').checked = true;
        document.getElementById('selectAll').indeterminate = false;
        updateSelectedCount();
    });

    // Select None button
    document.getElementById('selectNoneBtn').addEventListener('click', function () {
        const checkboxes = document.querySelectorAll('.customer-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
            const row = checkbox.closest('tr');
            row.classList.remove('table-primary');
            row.style.backgroundColor = '';
        });
        document.getElementById('selectAll').checked = false;
        document.getElementById('selectAll').indeterminate = false;
        updateSelectedCount();
    });

    // Select Visible button
    document.getElementById('selectVisibleBtn').addEventListener('click', function () {
        const checkboxes = document.querySelectorAll('.customer-checkbox');

        checkboxes.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row && row.style.display !== 'none') {
                checkbox.checked = true;
                row.classList.add('table-primary');
                row.style.backgroundColor = '#cfe2ff';
            }
        });

        updateSelectedCount();
    });

    // Individual checkbox change
    document.addEventListener('change', function (e) {
        if (e.target.classList.contains('customer-checkbox')) {
            // Add visual feedback for selected rows
            const row = e.target.closest('tr');
            if (e.target.checked) {
                row.classList.add('table-primary');
                row.style.backgroundColor = '#cfe2ff';
            } else {
                row.classList.remove('table-primary');
                row.style.backgroundColor = '';
            }

            updateSelectedCount();

            // Update "Select All" state
            const allCheckboxes = document.querySelectorAll('.customer-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAll');

            if (checkedCheckboxes.length === allCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
        }
    });

    // Update selected count
    function updateSelectedCount() {
        const checkedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');
        const totalCheckboxes = document.querySelectorAll('.customer-checkbox');
        const visibleCheckboxes = document.querySelectorAll('.customer-checkbox');

        // Filter visible checkboxes (not hidden by search)
        const actuallyVisibleCheckboxes = Array.from(visibleCheckboxes).filter(checkbox => {
            const row = checkbox.closest('tr');
            return row && row.style.display !== 'none';
        });

        // Update displays
        document.getElementById('selectedCount').textContent = checkedCheckboxes.length;
        document.getElementById('selectedCountInfo').textContent = checkedCheckboxes.length;

        // Update selection info badge
        const selectionInfo = document.getElementById('selectionInfo');
        if (checkedCheckboxes.length === 0) {
            selectionInfo.className = 'badge bg-secondary';
            selectionInfo.innerHTML = '<span id="selectedCountInfo">0</span> selected';
        } else if (checkedCheckboxes.length === totalCheckboxes.length) {
            selectionInfo.className = 'badge bg-success';
            selectionInfo.innerHTML = `<span id="selectedCountInfo">${checkedCheckboxes.length}</span> selected (All)`;
        } else {
            selectionInfo.className = 'badge bg-primary';
            selectionInfo.innerHTML = `<span id="selectedCountInfo">${checkedCheckboxes.length}</span> of ${totalCheckboxes.length} selected`;
        }

        // Enable/disable campaign button
        const sendBtn = document.getElementById('sendCampaignBtn');
        if (sendBtn) {
            const messageTemplate = document.getElementById('message_template').value.trim();
            sendBtn.disabled = checkedCheckboxes.length === 0 || messageTemplate === '';
        }

        // Update button states
        updateButtonStates();
    }

    // Update button states based on selection
    function updateButtonStates() {
        const checkedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');
        const totalCheckboxes = document.querySelectorAll('.customer-checkbox');
        const visibleCheckboxes = Array.from(totalCheckboxes).filter(checkbox => {
            const row = checkbox.closest('tr');
            return row && row.style.display !== 'none';
        });

        // Update button text and states
        const selectAllBtn = document.getElementById('selectAllBtn');
        const selectNoneBtn = document.getElementById('selectNoneBtn');
        const selectVisibleBtn = document.getElementById('selectVisibleBtn');

        if (checkedCheckboxes.length === totalCheckboxes.length) {
            selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> All Selected';
            selectAllBtn.disabled = true;
        } else {
            selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Select All';
            selectAllBtn.disabled = false;
        }

        if (checkedCheckboxes.length === 0) {
            selectNoneBtn.innerHTML = '<i class="fas fa-square"></i> None Selected';
            selectNoneBtn.disabled = true;
        } else {
            selectNoneBtn.innerHTML = '<i class="fas fa-square"></i> Select None';
            selectNoneBtn.disabled = false;
        }

        const checkedVisibleCount = Array.from(checkedCheckboxes).filter(checkbox => {
            const row = checkbox.closest('tr');
            return row && row.style.display !== 'none';
        }).length;

        if (checkedVisibleCount === visibleCheckboxes.length && visibleCheckboxes.length > 0) {
            selectVisibleBtn.innerHTML = '<i class="fas fa-eye"></i> Visible Selected';
            selectVisibleBtn.disabled = true;
        } else {
            selectVisibleBtn.innerHTML = `<i class="fas fa-eye"></i> Select Visible (${visibleCheckboxes.length})`;
            selectVisibleBtn.disabled = visibleCheckboxes.length === 0;
        }
    }

    // Message template change
    document.getElementById('message_template').addEventListener('input', function () {
        updateSelectedCount();
        updatePreview();
    });

    // Update message preview
    function updatePreview() {
        const template = document.getElementById('message_template').value;
        const preview = document.getElementById('messagePreview');

        if (template.trim() === '') {
            preview.innerHTML = '<em class="text-muted">Enter a message to see preview...</em>';
            return;
        }

        // Replace variables with sample data for preview
        let previewText = template
            .replace(/{name}/g, '<strong>John Doe</strong>')
            .replace(/{first_name}/g, '<strong>John</strong>')
            .replace(/{last_name}/g, '<strong>Doe</strong>');

        preview.innerHTML = previewText;
    }

    // Quick templates
    const templates = {
        greeting: "Hello {first_name}! 👋\n\nHope you're doing well. Just wanted to reach out and see how everything is going with your groups.\n\nBest regards,\nGENIOTech Team",
        reminder: "Hi {first_name}! 📚\n\nThis is a friendly reminder about your upcoming session. Please let us know if you need to reschedule.\n\nThank you!\nGENIOTech Team",
        promotion: "Hello {first_name}! 🎉\n\nWe have an exciting new offer just for you! Check out our latest groups and special discounts.\n\nDon't miss out!\nGENIOTech Team",
        followup: "Hi {first_name}! 📞\n\nFollowing up on our previous conversation. Please let us know if you have any questions or need assistance.\n\nBest regards,\nGENIOTech Team"
    };

    function useTemplate(templateName) {
        document.getElementById('message_template').value = templates[templateName];
        updatePreview();
        updateSelectedCount();
    }

    // Handle campaign form submission
    document.getElementById('campaignForm').addEventListener('submit', function (e) {
        const checkedCheckboxes = document.querySelectorAll('.customer-checkbox:checked');

        if (checkedCheckboxes.length === 0) {
            e.preventDefault();
            alert('Please select at least one customer for the campaign.');
            return;
        }

        // Add selected customer IDs to form
        checkedCheckboxes.forEach(checkbox => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'selected_customers';
            hiddenInput.value = checkbox.value;
            this.appendChild(hiddenInput);
        });
    });

    // Initialize button states on page load
    document.addEventListener('DOMContentLoaded', function () {
        updateSelectedCount();
    });
</script>
{% endblock %}