{% extends "base.html" %}

{% block title %}{{ group.name }} - Group Analytics & Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Group Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('groups') }}">Groups</a></li>
                    <li class="breadcrumb-item active">{{ group.name }}</li>
                </ol>
            </nav>

            <div class="card border-0 shadow-sm bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-1"><i class="fas fa-users"></i> {{ group.name }}</h2>
                            <p class="mb-2 text-white-50">{{ group.subject }}</p>
                            <div class="d-flex flex-wrap gap-2">
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-chalkboard-teacher"></i> {{ group.instructor.first_name }} {{
                                    group.instructor.last_name }}
                                </span>
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-calendar"></i> {{ group_stats.active_since_days }} days active
                                </span>
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-user-friends"></i> {{ group_stats.total_members }}/{{
                                    group.max_students }} members
                                </span>
                                {% if group.category %}
                                <span class="badge bg-light text-dark">
                                    <i class="fas fa-tag"></i> {{ group.category.name }}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <div class="btn-group">
                                <a href="{{ url_for('edit_group', group_id=group.id) }}" class="btn btn-light">
                                    <i class="fas fa-edit"></i> Edit Group
                                </a>
                                <a href="{{ url_for('groups') }}" class="btn btn-outline-light">
                                    <i class="fas fa-arrow-left"></i> Back
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Dashboard -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="fas fa-calendar-check fa-2x"></i>
                    </div>
                    <h4 class="mb-1">{{ group_stats.completed_sessions }}</h4>
                    <p class="text-muted mb-0">Completed Sessions</p>
                    <small class="text-success">{{ group_stats.completion_rate }}% completion rate</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                    <h4 class="mb-1">{{ group_stats.attendance_rate }}%</h4>
                    <p class="text-muted mb-0">Attendance Rate</p>
                    <small class="text-info">Across all sessions</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                    <h4 class="mb-1">{{ "%.0f"|format(group_stats.avg_session_duration) }}</h4>
                    <p class="text-muted mb-0">Avg. Session (min)</p>
                    <small class="text-info">{{ group_stats.total_sessions }} total sessions</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                    <h4 class="mb-1">{{ group_stats.total_members }}</h4>
                    <p class="text-muted mb-0">Active Members</p>
                    <small class="text-success">{{ ((group_stats.total_members / group.max_students) * 100)|round(1) }}%
                        capacity</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom">
                    <ul class="nav nav-tabs card-header-tabs" id="groupTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab"
                                data-bs-target="#overview" type="button" role="tab">
                                <i class="fas fa-chart-pie"></i> Overview
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="members-tab" data-bs-toggle="tab" data-bs-target="#members"
                                type="button" role="tab">
                                <i class="fas fa-users"></i> Members ({{ group_stats.total_members }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions"
                                type="button" role="tab">
                                <i class="fas fa-calendar"></i> Sessions
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="attendance-tab" data-bs-toggle="tab"
                                data-bs-target="#attendance" type="button" role="tab">
                                <i class="fas fa-calendar-check"></i> Detailed Attendance
                            </button>
                        </li>
                        {% if current_user.role != 'instructor' %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="performance-tab" data-bs-toggle="tab"
                                data-bs-target="#performance" type="button" role="tab">
                                <i class="fas fa-chart-bar"></i> Performance
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history"
                                type="button" role="tab">
                                <i class="fas fa-history"></i> History
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>

                <div class="card-body">
                    <div class="tab-content" id="groupTabsContent">
                        <!-- Overview Tab -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel">
                            <div class="row">
                                <div class="col-lg-8 mb-4">
                                    <!-- Progress Chart -->
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-chart-area"></i> Monthly Progress
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="progressChart" height="100"></canvas>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-4 mb-4">
                                    <!-- Quick Actions -->
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-tools"></i> Quick Actions
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                {% if current_user.role != 'instructor' %}
                                                <button class="btn btn-primary" data-bs-toggle="modal"
                                                    data-bs-target="#addMemberModal">
                                                    <i class="fas fa-user-plus"></i> Add Member
                                                </button>
                                                <button class="btn btn-success" data-bs-toggle="modal"
                                                    data-bs-target="#addSessionModal">
                                                    <i class="fas fa-calendar-plus"></i> Schedule Session
                                                </button>
                                                {% endif %}
                                                <a href="{{ url_for('group_sessions', group_id=group.id) }}"
                                                    class="btn btn-info">
                                                    <i class="fas fa-list"></i> View All Sessions
                                                </a>
                                                {% if current_user.role != 'instructor' %}
                                                <button class="btn btn-warning" data-bs-toggle="modal"
                                                    data-bs-target="#addPerformanceModal">
                                                    <i class="fas fa-clipboard-check"></i> Add Assessment
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Group Details -->
                                    <div class="card border-0 shadow-sm mt-3">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-info-circle"></i> Group Details
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-4">Start Date</dt>
                                                <dd class="col-sm-8">{{ group.start_date.strftime('%Y-%m-%d') }}</dd>

                                                <dt class="col-sm-4">End Date</dt>
                                                <dd class="col-sm-8">
                                                    {{ group.end_date.strftime('%Y-%m-%d') if group.end_date else 'Ongoing' }}
                                                </dd>

                                                <dt class="col-sm-4">Status</dt>
                                                <dd class="col-sm-8">
                                                    <span class="badge bg-{{ 'success' if group.status == 'active' else 'warning' if group.status == 'inactive' else 'info' }}">
                                                        {{ group.status.title() }}
                                                    </span>
                                                </dd>

                                                <dt class="col-sm-4">Description</dt>
                                                <dd class="col-sm-8">{{ group.description or 'No description provided.' }}</dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Members Tab -->
                        <div class="tab-pane fade" id="members" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h4 class="mb-0">Group Members</h4>
                                {% if current_user.role != 'instructor' %}
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                                    <i class="fas fa-user-plus"></i> Add Member
                                </button>
                                {% endif %}
                            </div>

                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Member</th>
                                            <th>Attendance</th>
                                            <th>Present</th>
                                            <th>Late</th>
                                            <th>Absent</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for detail in member_performance %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div>
                                                        <h6 class="mb-0">{{ detail.customer.first_name }} {{ detail.customer.last_name }}</h6>
                                                        <small class="text-muted">Joined {{ detail.member.joined_date.strftime('%Y-%m-%d') }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="progress attendance-progress">
                                                    <div class="progress-bar bg-success attendance-progress-bar" role="progressbar"
                                                        {% set width = detail.attendance_rate|string + '%' %}
                                                        style="width: {{ width }}"
                                                        aria-valuenow="{{ detail.attendance_rate }}" aria-valuemin="0"
                                                        aria-valuemax="100">
                                                        {{ detail.attendance_rate|round(1) }}%
                                                    </div>
                                                </div>
                                            </td>
                                            <td><span class="badge bg-success">{{ detail.present_count }}</span></td>
                                            <td><span class="badge bg-warning">{{ detail.late_count }}</span></td>
                                            <td><span class="badge bg-danger">{{ detail.absent_count }}</span></td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('customer_detail', customer_id=detail.customer.id) }}"
                                                        class="btn btn-outline-primary">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    {% if current_user.role != 'instructor' %}
                                                    <form action="{{ url_for('remove_group_member', group_id=group.id, member_id=detail.member.id) }}"
                                                        method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to remove this member?');">
                                                        <button type="submit" class="btn btn-outline-danger">
                                                            <i class="fas fa-user-minus"></i>
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Detailed Attendance Tab -->
                        <div class="tab-pane fade" id="attendance" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>جدول الحضور التفصيلي</h5>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="exportAttendance()">
                                                <i class="fas fa-download"></i> تصدير
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="printAttendance()">
                                                <i class="fas fa-print"></i> طباعة
                                            </button>
                                        </div>
                                    </div>

                                    {% if attendance_matrix and members %}
                                    <div class="card shadow">
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-bordered table-sm" id="attendanceMatrix">
                                                    <thead class="table-dark">
                                                        <tr>
                                                            <th class="sticky-col">الطالب</th>
                                                            {% for session in recent_completed_sessions[:15] %}
                                                            <th class="text-center attendance-date">
                                                                {{ session.session_date.strftime('%m/%d') }}
                                                                <br><small>{{ session.session_date.strftime('%a')
                                                                    }}</small>
                                                            </th>
                                                            {% endfor %}
                                                            <th class="text-center">الإحصائيات</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for perf_data in member_performance %}
                                                        <tr>
                                                            <td class="sticky-col student-name">
                                                                <div class="d-flex align-items-center">
                                                                    <div
                                                                        class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                                        {{ perf_data.customer.first_name[0] }}{{
                                                                        perf_data.customer.last_name[0] }}
                                                                    </div>
                                                                    <div>
                                                                        <a href="{{ url_for('member_attendance_detail', group_id=group.id, customer_id=perf_data.customer.id) }}"
                                                                            class="text-decoration-none">
                                                                            <strong>{{ perf_data.customer.first_name }}
                                                                                {{ perf_data.customer.last_name
                                                                                }}</strong>
                                                                        </a>
                                                                        <br><small class="text-muted">{{
                                                                            perf_data.customer.phone or 'لا يوجد هاتف'
                                                                            }}</small>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            {% for session in recent_completed_sessions[:15] %}
                                                            {% set session_key =
                                                            session.session_date.strftime('%Y-%m-%d') + '_' +
                                                            session.id|string %}
                                                            {% set attendance_record =
                                                            attendance_matrix.get(session_key, {}).get('attendance',
                                                            {}).get(perf_data.customer.id) %}
                                                            <td class="text-center attendance-cell"
                                                                data-session-date="{{ session.session_date.strftime('%Y-%m-%d') }}"
                                                                data-student="{{ perf_data.customer.first_name }} {{ perf_data.customer.last_name }}">
                                                                {% if attendance_record %}
                                                                {% if attendance_record.status == 'present' %}
                                                                <span class="badge bg-success attendance-badge"
                                                                    title="حضر">✓</span>
                                                                {% elif attendance_record.status == 'late' %}
                                                                <span class="badge bg-warning attendance-badge"
                                                                    title="تأخير">⏰</span>
                                                                {% elif attendance_record.status == 'absent' %}
                                                                <span class="badge bg-danger attendance-badge"
                                                                    title="غياب">✗</span>
                                                                {% elif attendance_record.status == 'excused' %}
                                                                <span class="badge bg-info attendance-badge"
                                                                    title="غياب بعذر">📝</span>
                                                                {% endif %}
                                                                {% if attendance_record.notes %}
                                                                <i class="fas fa-comment-alt text-muted ms-1"
                                                                    title="{{ attendance_record.notes }}"></i>
                                                                {% endif %}
                                                                {% else %}
                                                                <span class="text-muted">-</span>
                                                                {% endif %}
                                                            </td>
                                                            {% endfor %}
                                                            <td class="text-center stats-cell">
                                                                <div class="d-flex flex-column align-items-center">
                                                                    <span class="badge bg-primary">{{
                                                                        perf_data.attendance_rate|round(1) }}%</span>
                                                                    <small class="text-muted mt-1">
                                                                        {{ perf_data.present_count }}/{{
                                                                        perf_data.total_sessions }}
                                                                    </small>
                                                                    {% if perf_data.current_streak > 0 %}
                                                                    <small class="text-success">
                                                                        <i class="fas fa-fire"></i> {{
                                                                        perf_data.current_streak }}
                                                                    </small>
                                                                    {% endif %}
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>

                                            <!-- Legend -->
                                            <div class="mt-3">
                                                <h6>مفتاح الرموز:</h6>
                                                <div class="row">
                                                    <div class="col-md-3 col-6 mb-2">
                                                        <span class="badge bg-success me-2">✓</span> حضر
                                                    </div>
                                                    <div class="col-md-3 col-6 mb-2">
                                                        <span class="badge bg-warning me-2">⏰</span> تأخير
                                                    </div>
                                                    <div class="col-md-3 col-6 mb-2">
                                                        <span class="badge bg-danger me-2">✗</span> غياب
                                                    </div>
                                                    <div class="col-md-3 col-6 mb-2">
                                                        <span class="badge bg-info me-2">📝</span> غياب بعذر
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Summary Statistics -->
                                            <div class="row mt-4">
                                                <div class="col-md-6">
                                                    <div class="card bg-light">
                                                        <div class="card-body">
                                                            <h6 class="card-title">إحصائيات المجموعة</h6>
                                                            <div class="row text-center">
                                                                <div class="col-3">
                                                                    <div class="h5 mb-0 text-success">
                                                                        {{
                                                                        member_performance|map(attribute='present_count')|sum
                                                                        }}
                                                                    </div>
                                                                    <small class="text-muted">حضر</small>
                                                                </div>
                                                                <div class="col-3">
                                                                    <div class="h5 mb-0 text-warning">
                                                                        {{
                                                                        member_performance|map(attribute='late_count')|sum
                                                                        }}
                                                                    </div>
                                                                    <small class="text-muted">تأخير</small>
                                                                </div>
                                                                <div class="col-3">
                                                                    <div class="h5 mb-0 text-danger">
                                                                        {{
                                                                        member_performance|map(attribute='absent_count')|sum
                                                                        }}
                                                                    </div>
                                                                    <small class="text-muted">غياب</small>
                                                                </div>
                                                                <div class="col-3">
                                                                    <div class="h5 mb-0 text-info">
                                                                        {{
                                                                        member_performance|map(attribute='excused_count')|sum
                                                                        }}
                                                                    </div>
                                                                    <small class="text-muted">عذر</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="card bg-light">
                                                        <div class="card-body">
                                                            <h6 class="card-title">معدلات الحضور</h6>
                                                            <div class="row text-center">
                                                                <div class="col-4">
                                                                    <div class="h5 mb-0 text-success">
                                                                        {{
                                                                        ((member_performance|map(attribute='attendance_rate')|sum)
                                                                        / (member_performance|length))|round(1) if
                                                                        member_performance|length > 0 else 0 }}%
                                                                    </div>
                                                                    <small class="text-muted">متوسط المجموعة</small>
                                                                </div>
                                                                <div class="col-4">
                                                                    <div class="h5 mb-0 text-primary">
                                                                        {{
                                                                        member_performance|map(attribute='attendance_rate')|max|round(1)
                                                                        if member_performance|length > 0 else 0 }}%
                                                                    </div>
                                                                    <small class="text-muted">أعلى معدل</small>
                                                                </div>
                                                                <div class="col-4">
                                                                    <div class="h5 mb-0 text-secondary">
                                                                        {{
                                                                        member_performance|map(attribute='attendance_rate')|min|round(1)
                                                                        if member_performance|length > 0 else 0 }}%
                                                                    </div>
                                                                    <small class="text-muted">أقل معدل</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-calendar-times fa-4x text-muted mb-3"></i>
                                        <h5>لا توجد بيانات حضور</h5>
                                        <p class="text-muted">لم يتم تسجيل أي حضور للمجموعة بعد</p>
                                        <a href="{{ url_for('group_sessions', group_id=group.id) }}"
                                            class="btn btn-primary">
                                            <i class="fas fa-calendar-plus"></i> جدولة حصة جديدة
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Sessions Tab -->
                        <div class="tab-pane fade" id="sessions" role="tabpanel">
                            <div class="row">
                                <!-- Upcoming Sessions -->
                                <div class="col-lg-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-calendar-plus"></i> Upcoming Sessions
                                            </h5>
                                            <button class="btn btn-sm btn-success" data-bs-toggle="modal"
                                                data-bs-target="#addSessionModal">
                                                <i class="fas fa-plus"></i> Add
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            {% if upcoming_sessions %}
                                            {% for session in upcoming_sessions %}
                                            <div
                                                class="d-flex justify-content-between align-items-center border-bottom py-3">
                                                <div>
                                                    <h6 class="mb-1">{{ session.session_date.strftime('%a, %b %d, %Y')
                                                        }}</h6>
                                                    <p class="mb-1">
                                                        <i class="fas fa-clock text-muted"></i>
                                                        {{ session.start_time.strftime('%H:%M') }} - {{
                                                        session.end_time.strftime('%H:%M') }}
                                                    </p>
                                                    {% if session.topic %}
                                                    <p class="mb-1"><strong>{{ session.topic }}</strong></p>
                                                    {% endif %}
                                                    {% if session.location %}
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt"></i> {{ session.location }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <span class="badge bg-primary">{{ session.status.title() }}</span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                            {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-calendar-times fa-2x text-muted mb-2"></i>
                                                <p class="text-muted">No upcoming sessions</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Sessions -->
                                <div class="col-lg-6 mb-4">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">
                                                <i class="fas fa-history"></i> Recent Sessions
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            {% if recent_sessions %}
                                            {% for session in recent_sessions %}
                                            <div
                                                class="d-flex justify-content-between align-items-center border-bottom py-3">
                                                <div>
                                                    <h6 class="mb-1">{{ session.session_date.strftime('%a, %b %d, %Y')
                                                        }}</h6>
                                                    <p class="mb-1">
                                                        <i class="fas fa-clock text-muted"></i>
                                                        {{ session.start_time.strftime('%H:%M') }} - {{
                                                        session.end_time.strftime('%H:%M') }}
                                                    </p>
                                                    {% if session.topic %}
                                                    <p class="mb-1"><strong>{{ session.topic }}</strong></p>
                                                    {% endif %}
                                                    {% if session.location %}
                                                    <small class="text-muted">
                                                        <i class="fas fa-map-marker-alt"></i> {{ session.location }}
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <span
                                                        class="badge bg-{{ 'success' if session.status == 'completed' else 'danger' if session.status == 'cancelled' else 'secondary' }}">
                                                        {{ session.status.title() }}
                                                    </span>
                                                    {% if session.status == 'completed' %}
                                                    <br>
                                                    <a href="{{ url_for('group_session_attendance', session_id=session.id) }}"
                                                        class="btn btn-outline-primary btn-sm mt-1">
                                                        <i class="fas fa-clipboard-check"></i> Attendance
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                            <div class="text-center mt-3">
                                                <a href="{{ url_for('group_sessions', group_id=group.id) }}"
                                                    class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-list"></i> View All Sessions
                                                </a>
                                            </div>
                                            {% else %}
                                            <div class="text-center py-4">
                                                <i class="fas fa-calendar fa-2x text-muted mb-2"></i>
                                                <p class="text-muted">No sessions yet</p>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Tab -->
                        {% if current_user.role != 'instructor' %}
                        <div class="tab-pane fade" id="performance" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h5>Student Performance Overview</h5>
                                        {% if current_user.role != 'instructor' %}
                                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                            data-bs-target="#addPerformanceModal">
                                            <i class="fas fa-plus"></i> Add Assessment
                                        </button>
                                        {% endif %}
                                    </div>

                                    <!-- Performance Summary -->
                                    <div class="row mb-4">
                                        {% for perf_data in member_performance %}
                                        <div class="col-lg-6 mb-3">
                                            <div class="card border-0 shadow-sm">
                                                <div class="card-body">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div>
                                                            <h6 class="mb-1">{{ perf_data.customer.first_name }} {{
                                                                perf_data.customer.last_name }}</h6>
                                                            <p class="text-muted mb-2">
                                                                Attendance: {{ "%.1f"|format(perf_data.attendance_rate)
                                                                }}% |
                                                                {% if perf_data.avg_score %}Score: {{
                                                                "%.1f"|format(perf_data.avg_score) }}%{% else %}No
                                                                scores{% endif %}
                                                            </p>
                                                        </div>
                                                        <div class="text-end">
                                                            {% if perf_data.avg_score %}
                                                            <span
                                                                class="badge bg-{{ 'success' if perf_data.avg_score >= 80 else 'warning' if perf_data.avg_score >= 60 else 'danger' }} fs-6">
                                                                {{ "%.0f"|format(perf_data.avg_score) }}%
                                                            </span>
                                                            {% endif %}
                                                        </div>
                                                    </div>

                                                    {% if perf_data.recent_performances %}
                                                    <div class="mt-3">
                                                        <small class="text-muted mb-2 d-block">Recent
                                                            Assessments:</small>
                                                        {% for performance in perf_data.recent_performances %}
                                                        <div
                                                            class="d-flex justify-content-between align-items-center py-1">
                                                            <div>
                                                                <small>{{ performance.assessment_type.title() }}</small>
                                                                <br>
                                                                <small class="text-muted">{{
                                                                    performance.assessment_date.strftime('%Y-%m-%d')
                                                                    }}</small>
                                                            </div>
                                                            <div>
                                                                {% if performance.score %}
                                                                <span
                                                                    class="badge bg-{{ 'success' if performance.score >= 80 else 'warning' if performance.score >= 60 else 'danger' }}">
                                                                    {{ "%.0f"|format(performance.score) }}%
                                                                </span>
                                                                {% endif %}
                                                                {% if performance.grade %}
                                                                <span class="badge bg-secondary">{{ performance.grade
                                                                    }}</span>
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- History Tab -->
                        <div class="tab-pane fade" id="history" role="tabpanel">
                            <div class="row">
                                <div class="col-12">
                                    <h5 class="mb-3">Group Activity Timeline</h5>

                                    {% if group_history %}
                                    <div class="timeline">
                                        {% for event in group_history %}
                                        <div class="timeline-item">
                                            <div
                                                class="timeline-marker bg-{{ 'primary' if event.event_type == 'created' else 'success' if 'member' in event.event_type else 'info' if 'session' in event.event_type else 'secondary' }}">
                                            </div>
                                            <div class="timeline-content">
                                                <h6 class="mb-1">{{ event.event_description }}</h6>
                                                <p class="text-muted mb-1">
                                                    <i class="fas fa-clock"></i> {{ event.created_at.strftime('%Y-%m-%d
                                                    %H:%M') }}
                                                    {% if event.created_by %}
                                                    | <i class="fas fa-user"></i> {{ event.created_by.first_name }} {{
                                                    event.created_by.last_name }}
                                                    {% endif %}
                                                </p>
                                                <span class="badge bg-light text-dark">{{ event.event_type.replace('_',
                                                    ' ').title() }}</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="text-center py-5">
                                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                                        <h5 class="text-muted">No activity history yet</h5>
                                        <p class="text-muted">Group activities will appear here as they happen.</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Member Modal -->
<div class="modal fade" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_group_member', group_id=group.id) }}" id="addMemberForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMemberModalLabel">Add Member to Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="customer_id" class="form-label">Select Customer</label>
                        <select class="form-select" id="customer_id" name="customer_id" required>
                            <option value="">Choose a customer...</option>
                            {% for customer in available_customers %}
                            <option value="{{ customer.id }}">{{ customer.first_name }} {{ customer.last_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Member</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Session Modal -->
<div class="modal fade" id="addSessionModal" tabindex="-1" aria-labelledby="addSessionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_group_session', group_id=group.id) }}" id="addSessionForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSessionModalLabel">Schedule New Session</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="session_date" class="form-label">Session Date</label>
                        <input type="date" class="form-control" id="session_date" name="session_date" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_time" class="form-label">Start Time</label>
                                <input type="time" class="form-control" id="start_time" name="start_time" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end_time" class="form-label">End Time</label>
                                <input type="time" class="form-control" id="end_time" name="end_time" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location">
                    </div>
                    <div class="mb-3">
                        <label for="topic" class="form-label">Topic</label>
                        <input type="text" class="form-control" id="topic" name="topic">
                    </div>
                    <div class="mb-3">
                        <label for="session_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="session_notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Schedule Session</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Performance Modal -->
<div class="modal fade" id="addPerformanceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Student Assessment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_performance_record') }}">
                <input type="hidden" name="group_id" value="{{ group.id }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="customer_id_perf" class="form-label">Student</label>
                                <select class="form-select" id="customer_id_perf" name="customer_id" required>
                                    <option value="">Select student...</option>
                                    {% for member, customer in members %}
                                    <option value="{{ customer.id }}">{{ customer.first_name }} {{ customer.last_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assessment_date" class="form-label">Assessment Date</label>
                                <input type="date" class="form-control" id="assessment_date" name="assessment_date"
                                    required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assessment_type" class="form-label">Assessment Type</label>
                                <select class="form-select" id="assessment_type" name="assessment_type" required>
                                    <option value="">Select type...</option>
                                    <option value="quiz">Quiz</option>
                                    <option value="exam">Exam</option>
                                    <option value="project">Project</option>
                                    <option value="participation">Participation</option>
                                    <option value="assignment">Assignment</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="score" class="form-label">Score (%)</label>
                                <input type="number" class="form-control" id="score" name="score" min="0" max="100"
                                    step="0.1">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="grade" class="form-label">Grade (Optional)</label>
                        <input type="text" class="form-control" id="grade" name="grade" placeholder="A, B, C, etc.">
                    </div>
                    <div class="mb-3">
                        <label for="perf_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="perf_notes" name="notes" rows="3"
                            placeholder="Assessment notes and feedback..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning">Add Assessment</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Form validation and submission handling
    document.addEventListener('DOMContentLoaded', function() {
        // Add Member Form
        const addMemberForm = document.getElementById('addMemberForm');
        if (addMemberForm) {
            addMemberForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const customerId = document.getElementById('customer_id').value;
                if (!customerId) {
                    alert('Please select a customer');
                    return;
                }
                this.submit();
            });
        }

        // Add Session Form
        const addSessionForm = document.getElementById('addSessionForm');
        if (addSessionForm) {
            addSessionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const sessionDate = document.getElementById('session_date').value;
                const startTime = document.getElementById('start_time').value;
                const endTime = document.getElementById('end_time').value;

                if (!sessionDate || !startTime || !endTime) {
                    alert('Please fill in all required fields');
                    return;
                }

                // Validate end time is after start time
                const sessionDateTime = new Date(sessionDate + 'T' + startTime);
                const endDateTime = new Date(sessionDate + 'T' + endTime);
                if (endDateTime <= sessionDateTime) {
                    alert('End time must be after start time');
                    return;
                }

                this.submit();
            });
        }
    });

    // Monthly Progress Chart
    const ctx = document.getElementById('progressChart').getContext('2d');
    const progressData = {{ monthly_progress|tojson }};
    
    const labels = Object.keys(progressData);
    const data = Object.values(progressData);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Sessions per Month',
                data: data,
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // Attendance matrix functionality
    function exportAttendance() {
        const table = document.getElementById('attendanceMatrix');
        if (!table) return;

        let csv = '';
        const rows = table.querySelectorAll('tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('th, td');
            const rowData = [];

            cells.forEach(cell => {
                // Clean text content and remove extra whitespace
                let text = cell.textContent.trim();
                text = text.replace(/\s+/g, ' '); // Replace multiple spaces with single space
                text = text.replace(/"/g, '""'); // Escape quotes
                rowData.push(`"${text}"`);
            });

            csv += rowData.join(',') + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `attendance_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function printAttendance() {
        const printContent = document.getElementById('attendanceMatrix');
        if (!printContent) return;

        const groupName = "{{ group.name }}";
        const printDate = new Date().toLocaleDateString('ar-EG');

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
                    <html>
                    <head>
                        <title>جدول الحضور - ${groupName}</title>
                        <style>
                            @media print {
                                body { font-family: Arial, sans-serif; direction: rtl; }
                                table { width: 100%; border-collapse: collapse; font-size: 12px; }
                                th, td { border: 1px solid #ddd; padding: 4px; text-align: center; }
                                th { background-color: #f5f5f5; font-weight: bold; }
                                .attendance-badge { padding: 2px 6px; border-radius: 3px; }
                                .bg-success { background-color: #d4edda; color: #155724; }
                                .bg-warning { background-color: #fff3cd; color: #856404; }
                                .bg-danger { background-color: #f8d7da; color: #721c24; }
                                .bg-info { background-color: #d1ecf1; color: #0c5460; }
                                .header { text-align: center; margin-bottom: 20px; }
                                .footer { text-align: center; margin-top: 20px; font-size: 10px; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>جدول الحضور التفصيلي</h2>
                            <h3>${groupName}</h3>
                            <p>تاريخ الطباعة: ${printDate}</p>
                        </div>
                        ${printContent.outerHTML}
                        <div class="footer">
                            <p>تم إنشاؤه بواسطة نظام GENIOTECH</p>
                        </div>
                    </body>
                    </html>
                `);
        printWindow.document.close();
        printWindow.print();
    }

    // Tooltip for attendance cells
    const attendanceCells = document.querySelectorAll('.attendance-cell');
    attendanceCells.forEach(cell => {
        cell.addEventListener('mouseenter', function () {
            const sessionDate = this.dataset.sessionDate;
            const student = this.dataset.student;
            if (sessionDate && student) {
                this.title = `${student} - ${sessionDate}`;
            }
        });
    });
</script>

<style>
    /* Attendance matrix styles */
    #attendanceMatrix {
        font-size: 0.9rem;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        background-color: #fff;
        z-index: 10;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        min-width: 200px;
        max-width: 250px;
    }

    .attendance-date {
        min-width: 80px;
        writing-mode: vertical-rl;
        text-orientation: mixed;
    }

    .attendance-cell {
        min-width: 80px;
        position: relative;
    }

    .attendance-badge {
        font-size: 1em;
        padding: 4px 8px;
        border-radius: 50%;
        min-width: 30px;
        display: inline-block;
    }

    .student-name {
        white-space: nowrap;
    }

    .stats-cell {
        min-width: 100px;
        background-color: #f8f9fa;
    }

    .avatar-sm {
        width: 40px;
        height: 40px;
        font-size: 14px;
        font-weight: bold;
    }

    /* Print styles */
    @media print {

        .btn,
        .card-header,
        .nav-tabs {
            display: none !important;
        }

        .sticky-col {
            position: static !important;
        }

        #attendanceMatrix {
            font-size: 8px !important;
        }

        .attendance-badge {
            background-color: transparent !important;
            border: 1px solid #000 !important;
            color: #000 !important;
        }
    }

    /* Responsive table */
    @media (max-width: 768px) {
        .attendance-date {
            writing-mode: horizontal-tb;
            text-orientation: initial;
            min-width: 60px;
        }

        .sticky-col {
            min-width: 150px;
            max-width: 180px;
        }

        #attendanceMatrix {
            font-size: 0.8rem;
        }
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .timeline {
        position: relative;
        padding-left: 30px;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 10px;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #e9ecef;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 25px;
    }

    .timeline-marker {
        position: absolute;
        left: -25px;
        top: 5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #e9ecef;
    }

    .timeline-content {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border-left: 4px solid #dee2e6;
    }

    .progress {
        border-radius: 10px;
    }

    .card {
        transition: transform 0.2s ease-in-out;
    }

    .card:hover {
        transform: translateY(-2px);
    }

    .nav-tabs .nav-link {
        border: none;
        color: #6c757d;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        background-color: transparent;
        border-bottom: 3px solid #0d6efd;
        color: #0d6efd;
    }
</style>
{% endblock %}